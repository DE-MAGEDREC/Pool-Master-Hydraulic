// ====== TRANSLATIONS ======
const translations = {
  fr: {
    title: "Pool Master Hydraulic BE",
    langue: "Langue",
    piscine_tab: "Piscine",
    canalisations_tab: "Canalisations",
    pertes_tab: "Pertes singulières",
    pression_tab: "Pression & Température",
    resultats_tab: "Résultats / PDF",
    rect: "Rectangulaire",
    carre: "Carré",
    ronde: "Ronde",
    ovale: "Ovale",
    libre: "Libre",
    L: "Longueur (m)",
    l: "Largeur (m)",
    p: "Profondeur (m)",
    cote: "Côté (m)",
    D_piscine: "Diamètre (m)",
    a_ovale: "Grand axe (m)",
    b_ovale: "Petit axe (m)",
    t_recycl: "Temps recyclage (h)",
    D: "Diamètre canalisation (mm)",
    materiau: "Matériau",
    L_asp: "Longueur aspiration (m)",
    v_asp: "Vitesse aspiration (m/s)",
    L_ref: "Longueur refoulement (m)",
    v_ref: "Vitesse refoulement (m/s)",
    coudes90C_asp: "Coude 90º court",
    coudes90G_asp: "Coude 90º grand",
    tes_asp: "Tés",
    vannes_asp: "Vannes",
    coudes90C_ref: "Coude 90º court",
    coudes90G_ref: "Coude 90º grand",
    tes_ref: "Tés",
    vannes_ref: "Vannes",
    H_geo: "Hauteur géométrique (m)",
    dp_filtre: "Perte filtre (mCE)",
    resultats: "Résultats",
    surface: "Surface",
    volume: "Volume",
    debit: "Débit filtration",
    pertes_sing_asp: "Pertes singulières aspiration",
    pertes_sing_ref: "Pertes singulières refoulement",
    filtre: "Filtre",
    friction_asp: "Friction aspiration",
    friction_ref: "Friction refoulement",
    total_asp: "Total aspiration",
    total_ref: "Total refoulement",
    pertes_totales: "Pertes totales",
    suivant: "Suivant →",
    precedent: "← Précédent",
    exporter: "Exporter PDF",
    logout: "Déconnexion",
    alert_icon: "⚠️",
    bar: "Bar",
    psi: "PSI"
  },
  en: {
    title: "Pool Master Hydraulic BE",
    langue: "Language",
    piscine_tab: "Pool",
    canalisations_tab: "Pipes",
    pertes_tab: "Singular losses",
    pression_tab: "Pressure & Temperature",
    resultats_tab: "Results / PDF",
    rect: "Rectangular",
    carre: "Square",
    ronde: "Round",
    ovale: "Oval",
    libre: "Free form",
    L: "Length (m)",
    l: "Width (m)",
    p: "Depth (m)",
    cote: "Side (m)",
    D_piscine: "Diameter (m)",
    a_ovale: "Long axis (m)",
    b_ovale: "Short axis (m)",
    t_recycl: "Recycle time (h)",
    D: "Pipe diameter (mm)",
    materiau: "Material",
    L_asp: "Suction length (m)",
    v_asp: "Suction velocity (m/s)",
    L_ref: "Discharge length (m)",
    v_ref: "Discharge velocity (m/s)",
    coudes90C_asp: "Elbow 90º short",
    coudes90G_asp: "Elbow 90º long",
    tes_asp: "Tees",
    vannes_asp: "Valves",
    coudes90C_ref: "Elbow 90º short",
    coudes90G_ref: "Elbow 90º long",
    tes_ref: "Tees",
    vannes_ref: "Valves",
    H_geo: "Geometric height (m)",
    dp_filtre: "Filter loss (mCE)",
    resultats: "Results",
    surface: "Surface",
    volume: "Volume",
    debit: "Filtration flow rate",
    pertes_sing_asp: "Singular losses suction",
    pertes_sing_ref: "Singular losses discharge",
    filtre: "Filter",
    friction_asp: "Pipe friction suction",
    friction_ref: "Pipe friction discharge",
    total_asp: "Total suction",
    total_ref: "Total discharge",
    pertes_totales: "Total losses",
    suivant: "Next →",
    precedent: "← Previous",
    exporter: "Export PDF",
    logout: "Logout",
    alert_icon: "⚠️",
    bar: "Bar",
    psi: "PSI"
  },
  es: {
    title: "Pool Master Hydraulic BE",
    langue: "Idioma",
    piscine_tab: "Piscina",
    canalisations_tab: "Tuberías",
    pertes_tab: "Pérdidas singulares",
    pression_tab: "Presión & Temperatura",
    resultats_tab: "Resultados / PDF",
    rect: "Rectangular",
    carre: "Cuadrada",
    ronde: "Redonda",
    ovale: "Oval",
    libre: "Libre",
    L: "Longitud (m)",
    l: "Ancho (m)",
    p: "Profundidad (m)",
    cote: "Lado (m)",
    D_piscine: "Diámetro (m)",
    a_ovale: "Eje mayor (m)",
    b_ovale: "Eje menor (m)",
    t_recycl: "Tiempo reciclaje (h)",
    D: "Diámetro tubería (mm)",
    materiau: "Material",
    L_asp: "Longitud aspiración (m)",
    v_asp: "Velocidad aspiración (m/s)",
    L_ref: "Longitud impulsión (m)",
    v_ref: "Velocidad impulsión (m/s)",
    coudes90C_asp: "Codo 90º corto",
    coudes90G_asp: "Codo 90º largo",
    tes_asp: "Tés",
    vannes_asp: "Válvulas",
    coudes90C_ref: "Codo 90º corto",
    coudes90G_ref: "Codo 90º largo",
    tes_ref: "Tés",
    vannes_ref: "Válvulas",
    H_geo: "Altura geométrica (m)",
    dp_filtre: "Pérdida filtro (mCE)",
    resultats: "Resultados",
    surface: "Superficie",
    volume: "Volumen",
    debit: "Caudal filtración",
    pertes_sing_asp: "Pérdidas singulares aspiración",
    pertes_sing_ref: "Pérdidas singulares impulsión",
    filtre: "Filtro",
    friction_asp: "Fricción aspiración",
    friction_ref: "Fricción impulsión",
    total_asp: "Total aspiración",
    total_ref: "Total impulsión",
    pertes_totales: "Pérdidas totales",
    suivant: "Siguiente →",
    precedent: "← Anterior",
    exporter: "Exportar PDF",
    logout: "Cerrar sesión",
    alert_icon: "⚠️",
    bar: "Bar",
    psi: "PSI"
  }
};

// ===== GLOBAL =====
let currentLang = "fr";

// ===== NAVIGATION WIZARD =====
function suivant(id) {
  $('.tab-pane').removeClass('show active');
  $(id).addClass('show active');
  $('.nav-link').removeClass('active');
  $(`a[href="${id}"]`).addClass('active');
  calculerResultats();
}

function precedent(id) {
  $('.tab-pane').removeClass('show active');
  $(id).addClass('show active');
  $('.nav-link').removeClass('active');
  $(`a[href="${id}"]`).addClass('active');
  calculerResultats();
}

// ===== CHOIX FORMES =====
function choixForme() {
  const f = $('input[name="forme"]:checked').val();
  $('.forme-fields').hide();
  switch(f){
    case "rectangle": $('#rectangle-fields').show(); break;
    case "carre": $('#carre-fields').show(); break;
    case "ronde": $('#ronde-fields').show(); break;
    case "ovale": $('#ovale-fields').show(); break;
    case "libre": $('#libre-fields').show(); break;
  }
}

// ===== CONVERSION =====
function mceToBar(val){ return (val*0.0981).toFixed(2); }
function mceToPsi(val){ return (val*1.422).toFixed(2); }

// ===== CALCUL =====
function calculerResultats() {
  const t = translations[currentLang];

  // Piscine
  const forme = $('input[name="forme"]:checked').val();
  let surface=0, volume=0;
  const t_renouv = +$('#t_recycl').val() || 5;

  if (forme === "rectangle") {
    const L_val = +$('#L').val()||0;
    const l_val = +$('#l').val()||0;
    const p_val = +$('#p').val()||0;
    surface = L_val*l_val;
    volume = surface*p_val;
  } else if (forme === "carre") {
    const cote_val = +$('#cote').val()||0;
    const p_val = +$('#p_carre').val()||0;
    surface = cote_val*cote_val;
    volume = surface*p_val;
  } else if (forme === "ronde") {
    const D_val = +$('#D_piscine').val()||0;
    const p_val = +$('#p_r').val()||0;
    surface = Math.PI*Math.pow(D_val/2,2);
    volume = surface*p_val;
  } else if (forme === "ovale") {
    const a = +$('#a_ovale').val()||0;
    const b = +$('#b_ovale').val()||0;
    const p_val = +$('#p_o').val()||0;
    surface = Math.PI*(a/2)*(b/2);
    volume = surface*p_val;
  } else if (forme === "libre") {
    const L_val = +$('#L_libre').val()||0;
    const l_val = +$('#l_libre').val()||0;
    const p_val = +$('#p_libre').val()||0;
    surface = L_val*l_val;
    volume = surface*p_val;
  }

  const debit = volume / t_renouv;

  // Canalisations
  const DN = (+$('#D').val()||50)/1000;
  const v_asp = +$('#v_asp').val()||1;
  const v_ref = +$('#v_ref').val()||1;
  const lambda = ($('#materiau').val()==="PVC_souple") ? 0.035 : ($('#materiau').val()==="Turbulence") ? 0.316 : 0.02;
  const L_asp = +$('#L_asp').val()||0;
  const L_ref = +$('#L_ref').val()||0;
  const H_fric_asp = lambda*L_asp/DN*Math.pow(v_asp,2)/(2*9.81);
  const H_fric_ref = lambda*L_ref/DN*Math.pow(v_ref,2)/(2*9.81);

  // Pertes singulières
  function calcSing(c90C, c90G, te, vanne, V){
    const L_eq = ((+c90C||0)*30*DN)+((+c90G||0)*20*DN)+((+te||0)*40*DN)+((+vanne||0)*8*DN);
    return lambda*L_eq/DN*Math.pow(V,2)/(2*9.81);
  }
  const H_sing_asp = calcSing($('#coudes90C_asp').val(), $('#coudes90G_asp').val(), $('#tes_asp').val(), $('#vannes_asp').val(), v_asp);
  const H_sing_ref = calcSing($('#coudes90C_ref').val(), $('#coudes90G_ref').val(), $('#tes_ref').val(), $('#vannes_ref').val(), v_ref);

  const H_geo_val = +$('#H_geo').val()||0;
  const dp_filtre_val = +$('#dp_filtre').val()||0;

  const H_total_asp = H_sing_asp + H_fric_asp;
  const H_total_ref = H_sing_ref + H_fric_ref;
  const H_total = H_total_asp + H_total_ref + H_geo_val + dp_filtre_val;

  // Affichage
  const html = `
<b>${t.surface} :</b> ${surface.toFixed(2)} m²<br>
<b>${t.volume} :</b> ${volume.toFixed(2)} m³<br>
<b>${t.debit} :</b> ${debit.toFixed(2)} m³/h<br><hr>

<b>${t.alert_icon} ${t.pertes_sing_asp} :</b> ${H_sing_asp.toFixed(2)} mCE<br>
<small>≈ ${mceToBar(H_sing_asp)} ${t.bar} / ${mceToPsi(H_sing_asp)} ${t.psi}</small><br>
<b>${t.alert_icon} ${t.pertes_sing_ref} :</b> ${H_sing_ref.toFixed(2)} mCE<br>
<small>≈ ${mceToBar(H_sing_ref)} ${t.bar} / ${mceToPsi(H_sing_ref)} ${t.psi}</small><br>
<b>${t.H_geo} :</b> ${H_geo_val.toFixed(2)} mCE<br>
<b>${t.filtre} :</b> ${dp_filtre_val.toFixed(2)} mCE<br>
<b>${t.friction_asp} :</b> ${H_fric_asp.toFixed(2)} mCE<br>
<b>${t.friction_ref} :</b> ${H_fric_ref.toFixed(2)} mCE<br><hr>
<b>${t.total_asp} :</b> ${H_total_asp.toFixed(2)} mCE<br>
<b>${t.total_ref} :</b> ${H_total_ref.toFixed(2)} mCE<br>
<b>${t.pertes_totales} :</b> ${H_total.toFixed(2)} mCE
`;

  $('#res').html(html);
  $('#res_droite').html(html);
}

// ===== EXPORT PDF =====
$('#btn-pdf').on('click', function(){
  html2pdf().from(document.getElementById('res')).save();
});

// ===== LANGUE =====
function setLanguage(lang){
  currentLang = lang;
  const t = translations[lang];
  $('#page-title').text(t.title);
  $('#label-langue').text(t.langue);
  $('#tab-piscine').text(t.piscine_tab);
  $('#tab-canalisations').text(t.canalisations_tab);
  $('#tab-pertes').text(t.pertes_tab);
  $('#tab-pression').text(t.pression_tab);
  $('#tab-resultats').text(t.resultats_tab);

  $('#label-rect').text(t.rect);
  $('#label-carre').text(t.carre);
  $('#label-ronde').text(t.ronde);
  $('#label-ovale').text(t.ovale);
  $('#label-libre').text(t.libre);

  $('#label-L').text(t.L);
  $('#label-l').text(t.l);
  $('#label-p').text(t.p);
  $('#label-cote').text(t.cote);
  $('#label-D_piscine').text(t.D_piscine);
  $('#label-a_ovale').text(t.a_ovale);
  $('#label-b_ovale').text(t.b_ovale);
  $('#label-L_libre').text(t.L);
  $('#label-l_libre').text(t.l);
  $('#label-p_libre').text(t.p);

  $('#label-t_recycl').text(t.t_recycl);

  $('#label-D').text(t.D);
  $('#label-materiau').text(t.materiau);
  $('#label-L_asp').text(t.L_asp);
  $('#label-v_asp').text(t.v_asp);
  $('#label-L_ref').text(t.L_ref);
  $('#label-v_ref').text(t.v_ref);

  $('#label-coudes90C_asp').text(t.coudes90C_asp);
  $('#label-coudes90G_asp').text(t.coudes90G_asp);
  $('#label-tes_asp').text(t.tes_asp);
  $('#label-vannes_asp').text(t.vannes_asp);
  $('#label-coudes90C_ref').text(t.coudes90C_ref);
  $('#label-coudes90G_ref').text(t.coudes90G_ref);
  $('#label-tes_ref').text(t.tes_ref);
  $('#label-vannes_ref').text(t.vannes_ref);

  $('#label-H_geo').text(t.H_geo);
  $('#label-dp_filtre').text(t.dp_filtre);

  $('#btn-pdf').text(t.exporter);

  calculerResultats();
}

// ===== INITIALISATION =====
$(document).ready(function(){
  setLanguage(currentLang);
  calculerResultats();
  $('#lang-select').on('change', function(){ setLanguage($(this).val()); });
  $('input, select').on('input change', calculerResultats);
});
