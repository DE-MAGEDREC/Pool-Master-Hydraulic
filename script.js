// ====== TRADUCTIONS COMPLÈTES ======
const translations = {
  fr: {
    title: "Pool Master Hydraulic",
    langue: "Langue :",
    logout: "Déconnexion",
    piscine_tab: "Piscine",
    canalisations_tab: "Canalisations",
    pertes_tab: "Pertes singulières",
    pression_tab: "Pression & Température",
    resultats_tab: "Résultats / PDF",
    forme_piscine: "Forme de la piscine",
    forme_rect: "Rectangulaire",
    forme_carree: "Carrée",
    forme_rond: "Ronde",
    forme_ovale: "Ovale",
    forme_libre: "Libre",
    surface: "Surface",
    volume: "Volume",
    debit: "Débit filtration",
    pertes_sing_asp: "Pertes singulières aspiration",
    pertes_sing_ref: "Pertes singulières refoulement",
    filtre: "Perte filtre",
    hauteur: "Hauteur géométrique",
    friction: "Friction canalisations",
    total_asp: "Total aspiration",
    total_ref: "Total refoulement",
    pertes_totales: "Pertes totales",
    exporter: "Exporter PDF",
    suivant: "Suivant →",
    placeholders: {
      L: "Longueur (m)",
      l: "Largeur (m)",
      p: "Profondeur (m)",
      cote: "Côté (m)",
      p_carre: "Profondeur (m)",
      D_piscine: "Diamètre (m)",
      p_r: "Profondeur (m)",
      a_ovale: "Grand axe (m)",
      b_ovale: "Petit axe (m)",
      p_o: "Profondeur (m)",
      L_libre: "Longueur approximative (m)",
      l_libre: "Largeur approximative (m)",
      p_libre: "Profondeur (m)",
      t_recycl: "Temps de recyclage (h)",
      D: "Diamètre canalisation (mm)",
      L_asp: "Longueur aspiration (m)",
      v_asp: "Vitesse aspiration (m/s)",
      L_ref: "Longueur refoulement (m)",
      v_ref: "Vitesse refoulement (m/s)",
      coudes90C_asp: "Coude 90º court rayon",
      coudes90G_asp: "Coude 90º grand rayon",
      tes_asp: "Tés",
      vannes_asp: "Vannes",
      coudes90C_ref: "Coude 90º court rayon",
      coudes90G_ref: "Coude 90º grand rayon",
      tes_ref: "Tés",
      vannes_ref: "Vannes",
      H_geo: "Hauteur géométrique (m)",
      dp_filtre: "Perte de charge filtre (mCE)"
    }
  },
  en: {
    title: "Pool Master Hydraulic",
    langue: "Language :",
    logout: "Logout",
    piscine_tab: "Pool",
    canalisations_tab: "Pipes",
    pertes_tab: "Singular losses",
    pression_tab: "Pressure & Temperature",
    resultats_tab: "Results / PDF",
    forme_piscine: "Pool shape",
    forme_rect: "Rectangular",
    forme_carree: "Square",
    forme_rond: "Round",
    forme_ovale: "Oval",
    forme_libre: "Free form",
    surface: "Surface",
    volume: "Volume",
    debit: "Filtration flow",
    pertes_sing_asp: "Singular losses suction",
    pertes_sing_ref: "Singular losses discharge",
    filtre: "Filter loss",
    hauteur: "Geometric height",
    friction: "Pipe friction",
    total_asp: "Total suction",
    total_ref: "Total discharge",
    pertes_totales: "Total losses",
    exporter: "Export PDF",
    suivant: "Next →",
    placeholders: {
      L: "Length (m)",
      l: "Width (m)",
      p: "Depth (m)",
      cote: "Side (m)",
      p_carre: "Depth (m)",
      D_piscine: "Diameter (m)",
      p_r: "Depth (m)",
      a_ovale: "Long axis (m)",
      b_ovale: "Short axis (m)",
      p_o: "Depth (m)",
      L_libre: "Approx. length (m)",
      l_libre: "Approx. width (m)",
      p_libre: "Depth (m)",
      t_recycl: "Recycle time (h)",
      D: "Pipe diameter (mm)",
      L_asp: "Suction length (m)",
      v_asp: "Suction velocity (m/s)",
      L_ref: "Discharge length (m)",
      v_ref: "Discharge velocity (m/s)",
      coudes90C_asp: "Short radius elbow",
      coudes90G_asp: "Long radius elbow",
      tes_asp: "Tees",
      vannes_asp: "Valves",
      coudes90C_ref: "Short radius elbow",
      coudes90G_ref: "Long radius elbow",
      tes_ref: "Tees",
      vannes_ref: "Valves",
      H_geo: "Geometric height (m)",
      dp_filtre: "Filter loss (mCE)"
    }
  },
  es: {
    title: "Pool Master Hydraulic",
    langue: "Idioma :",
    logout: "Cerrar sesión",
    piscine_tab: "Piscina",
    canalisations_tab: "Tuberías",
    pertes_tab: "Pérdidas singulares",
    pression_tab: "Presión & Temperatura",
    resultats_tab: "Resultados / PDF",
    forme_piscine: "Forma de la piscina",
    forme_rect: "Rectangular",
    forme_carree: "Cuadrada",
    forme_rond: "Redonda",
    forme_ovale: "Oval",
    forme_libre: "Libre",
    surface: "Superficie",
    volume: "Volumen",
    debit: "Caudal filtración",
    pertes_sing_asp: "Pérdidas singulares aspiración",
    pertes_sing_ref: "Pérdidas singulares impulsión",
    filtre: "Pérdida de filtro",
    hauteur: "Altura geométrica",
    friction: "Fricción tuberías",
    total_asp: "Total aspiración",
    total_ref: "Total impulsión",
    pertes_totales: "Pérdidas totales",
    exporter: "Exportar PDF",
    suivant: "Siguiente →",
    placeholders: {
      L: "Longitud (m)",
      l: "Ancho (m)",
      p: "Profundidad (m)",
      cote: "Lado (m)",
      p_carre: "Profundidad (m)",
      D_piscine: "Diámetro (m)",
      p_r: "Profundidad (m)",
      a_ovale: "Eje mayor (m)",
      b_ovale: "Eje menor (m)",
      p_o: "Profundidad (m)",
      L_libre: "Longitud aprox. (m)",
      l_libre: "Ancho aprox. (m)",
      p_libre: "Profundidad (m)",
      t_recycl: "Tiempo reciclaje (h)",
      D: "Diámetro tubería (mm)",
      L_asp: "Longitud aspiración (m)",
      v_asp: "Velocidad aspiración (m/s)",
      L_ref: "Longitud impulsión (m)",
      v_ref: "Velocidad impulsión (m/s)",
      coudes90C_asp: "Codo radio corto",
      coudes90G_asp: "Codo radio largo",
      tes_asp: "Tés",
      vannes_asp: "Válvulas",
      coudes90C_ref: "Codo radio corto",
      coudes90G_ref: "Codo radio largo",
      tes_ref: "Tés",
      vannes_ref: "Válvulas",
      H_geo: "Altura geométrica (m)",
      dp_filtre: "Pérdida de filtro (mCE)"
    }
  }
};

let currentLang = "fr";

// ====== NAVIGATION ONGLET ======
function suivant(id) {
  $('.tab-pane').removeClass('show active');
  $(id).addClass('show active');
  $('.nav-link').removeClass('active');
  $(`a[href="${id}"]`).addClass('active');
  calculerResultats();
}

// ====== CHOIX FORMES ======
function choixForme() {
  const f = $('input[name="forme"]:checked').val();
  $('.forme-fields').hide();
  switch(f){
    case "rectangle": $('#rectangle-fields').show(); break;
    case "carre": $('#carre-fields').show(); break;
    case "ronde": $('#ronde-fields').show(); break;
    case "ovale": $('#ovale-fields').show(); break;
    case "libre": $('#libre-fields').show(); break;
  }
}

// ====== CONVERSION mCE -> BAR ======
function mceToBar(val){ return (val*0.0981).toFixed(2); }

// ====== CALCUL HYDRAULIQUE ======
function calculerResultats(){
  const t = translations[currentLang];

  // ----- Piscine -----
  const forme = $('input[name="forme"]:checked').val();
  let surface=0, volume=0;
  const t_recycl = +$('#t_recycl').val()||5;

  if(forme==="rectangle"){ surface=(+$('#L').val()||0)*(+$('#l').val()||0); volume=surface*(+$('#p').val()||0); }
  else if(forme==="carre"){ surface=Math.pow(+$('#cote').val()||0,2); volume=surface*(+$('#p_carre').val()||0);}
  else if(forme==="ronde"){ surface=Math.PI*Math.pow((+$('#D_piscine').val()||0)/2,2); volume=surface*(+$('#p_r').val()||0);}
  else if(forme==="ovale"){ surface=Math.PI*(+$('#a_ovale').val()||0)*(+$('#b_ovale').val()||0)/4; volume=surface*(+$('#p_o').val()||0);}
  else if(forme==="libre"){ surface=(+$('#L_libre').val()||0)*(+$('#l_libre').val()||0); volume=surface*(+$('#p_libre').val()||0);}
  const debit = volume / t_recycl;

  // ----- Canalisations -----
  const DN = (+$('#D').val()||50)/1000;
  const v_asp = +$('#v_asp').val()||1;
  const v_ref = +$('#v_ref').val()||1;
  const lambda = ($('#materiau').val()==="PVC_souple")?0.035:($('#materiau').val()==="Turbulence")?0.316:0.02;
  const L_asp = +$('#L_asp').val()||0;
  const L_ref = +$('#L_ref').val()||0;
  const H_fric_asp = lambda*L_asp/DN*Math.pow(v_asp,2)/(2*9.81);
  const H_fric_ref = lambda*L_ref/DN*Math.pow(v_ref,2)/(2*9.81);

  // ----- Pertes singulières -----
  function calcSing(c90C,c90G,te,vanne,V){ return lambda*((+c90C||0)*30*DN + (+c90G||0)*20*DN + (+te||0)*40*DN + (+vanne||0)*8*DN)/DN*Math.pow(V,2)/(2*9.81); }
  const H_sing_asp = calcSing($('#coudes90C_asp').val(),$('#coudes90G_asp').val(),$('#tes_asp').val(),$('#vannes_asp').val(),v_asp);
  const H_sing_ref = calcSing($('#coudes90C_ref').val(),$('#coudes90G_ref').val(),$('#tes_ref').val(),$('#vannes_ref').val(),v_ref);

  const H_geo_val = +$('#H_geo').val()||0;
  const dp_filtre_val = +$('#dp_filtre').val()||0;
  const H_total_asp = H_fric_asp+H_sing_asp;
  const H_total_ref = H_fric_ref+H_sing_ref;
  const H_total = H_total_asp + H_total_ref + H_geo_val + dp_filtre_val;

  const html = `
<b>${t.surface} :</b> ${surface.toFixed(2)} m²<br>
<b>${t.volume} :</b> ${volume.toFixed(2)} m³<br>
<b>${t.debit} :</b> ${debit.toFixed(2)} m³/h<br><hr>
<b>${t.pertes_sing_asp} :</b> ${H_sing_asp.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_sing_asp)}${t.en_bar}</small><br>
<b>${t.pertes_sing_ref} :</b> ${H_sing_ref.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_sing_ref)}${t.en_bar}</small><br>
<b>${t.hauteur} :</b> ${H_geo_val.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_geo_val)}${t.en_bar}</small><br>
<b>${t.filtre} :</b> ${dp_filtre_val.toFixed(2)} mCE<br><small>≈ ${mceToBar(dp_filtre_val)}${t.en_bar}</small><br>
<b>${t.friction} aspiration :</b> ${H_fric_asp.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_fric_asp)}${t.en_bar}</small><br>
<b>${t.friction} refoulement :</b> ${H_fric_ref.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_fric_ref)}${t.en_bar}</small><br><hr>
<b>${t.total_asp} :</b> ${H_total_asp.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_total_asp)}${t.en_bar}</small><br>
<b>${t.total_ref} :</b> ${H_total_ref.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_total_ref)}${t.en_bar}</small><br>
<b>${t.pertes_totales} :</b> ${H_total.toFixed(2)} mCE<br><small>≈ ${mceToBar(H_total)}${t.en_bar}</small>
`;

  $('#res').html(html);
  $('#res_droite_contenu').html(html);
}

// ====== EXPORT PDF ======
$('#btn-pdf').on('click',function(){ html2pdf().from(document.getElementById('res')).save(); });

// ====== CHANGEMENT LANGUE ======
function setLanguage(lang){
  currentLang = lang;
  const t = translations[lang];

  $('h2.text-center').text(t.title);
  $('.nav-link').each(function(){
    const key = $(this).data('i18n');
    if(key && t[key]) $(this).text(t[key]);
  });

  $('label[data-i18n]').each(function(){
    const key = $(this).data('i18n');
    if(key && t[key]) $(this).text(t[key]);
  });

  // Placeholders
  Object.keys(t.placeholders).forEach(id=>{
    $('#'+id).attr('placeholder', t.placeholders[id]);
  });

  // Boutons
  $('.btn-primary').text(t.suivant);
  $('#btn-pdf').text(t.exporter);

  calculerResultats();
}

// ====== INITIALISATION ======
$(document).ready(function(){
  setLanguage(currentLang);
  choixForme();
  calculerResultats();

  $('input, select').on('input change', function(){
    choixForme();
    calculerResultats();
  });

  $('#lang-select').on('change', function(){ setLanguage($(this).val()); });
});
